# How to Run Performance Tests with K6 in Docker

## Overview
This guide explains how to run k6 performance tests for the Auth service using Docker containers.
All tests run in isolated Docker containers to ensure consistent results.

================================================================================
PREREQUISITES
================================================================================

1. Docker Desktop installed and running
2. Git Bash or WSL (for Windows users)
3. At least 4GB of available RAM

================================================================================
QUICK START - Running Tests in Docker
================================================================================

1. Navigate to the project root:
   cd /d/CodingProjects/OnlineShop-perf-testing

2. Stop any existing containers:
   docker compose down
   docker compose -f tests/performance/docker compose.perf.yml down

3. Start the performance test environment (Auth service + Database):
   docker compose -f tests/performance/docker compose.perf.yml up -d

4. Wait for services to be healthy (usually 30-60 seconds):
   docker compose -f tests/performance/docker compose.perf.yml ps

   You should see both services as "healthy"

5. Run the tests using k6 in Docker:

   a) Smoke Test (Quick sanity check, ~2 minutes):
      docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run -e ENV=docker smoke.js

   b) Load Test (Realistic traffic, ~10 minutes):
      docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run -e ENV=docker load.js

   c) Stress Test (Find limits, ~20 minutes):
      docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run -e ENV=docker stress.js

6. Stop the environment when done:
   docker compose -f tests/performance/docker compose.perf.yml down

================================================================================
UNDERSTANDING THE TEST TYPES
================================================================================

SMOKE TEST (smoke.js)
- Purpose: Quick sanity check that service works
- Duration: ~2 minutes
- Load: 1 VU, 10 iterations
- When: Run on every PR or before other tests
- Command: docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run -e ENV=docker smoke.js

LOAD TEST (load.js)
- Purpose: Test under realistic/expected traffic
- Duration: ~10 minutes
- Load: 20-50 VUs with realistic ramp-up
- When: Run nightly or before releases
- Command: docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run -e ENV=docker load.js

STRESS TEST (stress.js)
- Purpose: Find breaking points and limits
- Duration: ~20 minutes
- Load: 0 → 50 → 100 → 200 → 300 VUs
- When: Run weekly or when investigating capacity
- Command: docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run -e ENV=docker stress.js

================================================================================
TRAFFIC MIX
================================================================================

All tests simulate realistic user behavior:
- 80% Token Validation (GET /api/v1/auth/validate)
- 10% Login (POST /api/v1/auth/login)
- 10% Registration (POST /api/v1/auth/register)

================================================================================
PERFORMANCE TARGETS (SLOs)
================================================================================

| Endpoint  | P95 Target | P99 Target |
|-----------|------------|------------|
| Login     | < 300ms    | < 500ms    |
| Validate  | < 50ms     | < 100ms    |
| Register  | < 500ms    | < 800ms    |

================================================================================
READING TEST RESULTS
================================================================================

Key Metrics to Watch:

1. http_req_duration - Overall request latency
   - avg: Average response time
   - p(95): 95% of requests faster than this
   - p(99): 99% of requests faster than this

2. http_req_failed - Error rate (should be < 1%)

3. Custom Metrics:
   - auth_login_duration: Login endpoint performance
   - auth_validate_duration: Validate endpoint performance
   - auth_register_duration: Register endpoint performance

4. checks: Validation checks (should be 100%)

Example Good Result:
  ✓ http_req_failed................: 0.00%
  ✓ auth_validate_duration.........: avg=8.45ms p(95)=23ms
  ✓ auth_login_duration............: avg=45.23ms p(95)=112ms

Example Bad Result:
  ✗ http_req_failed................: 5.23%  (too many errors!)
  ✗ auth_validate_duration.........: avg=234ms p(95)=890ms  (too slow!)

================================================================================
FINDING THE SERVICE LIMIT
================================================================================

To find the maximum capacity of the Auth service:

1. Start with the stress test:
   docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run -e ENV=docker stress.js

2. Watch the results at each load level:
   - 50 VUs: Should pass all thresholds
   - 100 VUs: May see slight degradation
   - 200 VUs: Approaching limits
   - 300 VUs: Likely to see failures

3. The service limit is reached when:
   - Error rate > 1%
   - P95 latency exceeds SLO targets
   - Response times start increasing exponentially

4. Check resource usage during tests:
   docker stats perf-auth-service perf-auth-postgres

   Look for:
   - CPU usage approaching 100%
   - Memory usage approaching limits
   - High I/O wait times

5. Review the generated report:
   - Reports are saved in: tests/performance/reports/
   - Filename format: stress-YYYY-MM-DDTHH-MM-SS.json

================================================================================
ADVANCED USAGE
================================================================================

1. Save Results to File:
   docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run \
     -e ENV=docker \
     --out json=/tests/reports/my-test.json \
     stress.js

2. Run with Custom Options:
   docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run \
     -e ENV=docker \
     --vus 100 \
     --duration 5m \
     stress.js

3. Monitor Live Logs:
   # Terminal 1: Watch service logs
   docker logs -f perf-auth-service

   # Terminal 2: Run test
   docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run -e ENV=docker stress.js

4. Compare Results:
   # Baseline
   docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run \
     -e ENV=docker --out json=/tests/baselines/baseline.json load.js

   # After changes
   docker compose -f tests/performance/docker compose.perf.yml run --rm k6 run \
     -e ENV=docker --out json=/tests/reports/after-changes.json load.js

================================================================================
TROUBLESHOOTING
================================================================================

Problem: "Service not responding"
Solution:
  1. Check if services are running:
     docker compose -f tests/performance/docker compose.perf.yml ps
  2. Check service logs:
     docker logs perf-auth-service
  3. Verify health:
     curl http://localhost:9001/actuator/health

Problem: "High error rate in tests"
Solution:
  1. Check database connections:
     docker logs perf-auth-postgres
  2. Check resource limits:
     docker stats
  3. Reduce load (VUs) to see if it helps

Problem: "Tests timing out"
Solution:
  1. Ensure Docker has sufficient resources (Settings → Resources)
  2. Wait longer for services to be healthy
  3. Check network connectivity:
     docker network inspect performance_perf-network

Problem: "Cannot find test files"
Solution:
  - Ensure you're in tests/performance directory or use full paths
  - Verify volume mounts: docker compose -f tests/performance/docker compose.perf.yml config

================================================================================
CLEANUP
================================================================================

Full cleanup (removes all data):
  docker compose -f tests/performance/docker compose.perf.yml down -v

Keep data for next run:
  docker compose -f tests/performance/docker compose.perf.yml down

Remove only k6 container:
  docker rm perf-k6

================================================================================
FILE LOCATIONS
================================================================================

Test Scripts:      tests/performance/*.js
Configuration:     tests/performance/config/
Test Results:      tests/performance/reports/
Baseline Results:  tests/performance/baselines/
Docker Compose:    tests/performance/docker compose.perf.yml
This Guide:        how-to-run-performance-tests.txt

================================================================================
TIPS FOR BEST RESULTS
================================================================================

1. Close unnecessary applications before running stress tests
2. Ensure Docker Desktop has at least 4GB RAM allocated
3. Run smoke test first to verify everything works
4. Use load test for regular performance monitoring
5. Use stress test only when investigating capacity/limits
6. Save baseline results to compare future changes
7. Monitor docker stats during tests to identify bottlenecks
8. Check service logs if you see unexpected failures

================================================================================
